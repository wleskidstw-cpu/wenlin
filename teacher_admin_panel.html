<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>教師管理後台 - 文林附幼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Klee+One:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f3ed; }
        .handwriting-font { font-family: 'Klee One', cursive; }
        .tab-btn.active { border-bottom: 3px solid #0f766e; color: #0f766e; font-weight: 700; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06); }
    </style>
</head>
<body>

    <!-- 登入介面 (預設顯示) -->
    <div id="login-view" class="min-h-screen flex items-center justify-center bg-teal-50">
        <div class="bg-white p-8 rounded-xl card-shadow w-full max-w-sm">
            <h2 class="text-3xl font-bold text-teal-700 mb-6 text-center handwriting-font">教師登入</h2>
            <form id="login-form" onsubmit="handleLogin(event)">
                <div class="mb-4">
                    <label for="username" class="block text-sm font-medium text-stone-700 mb-1">帳號 (Username)</label>
                    <input type="text" id="username" value="teacher" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-amber-500 focus:border-amber-500" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-stone-700 mb-1">密碼 (Password)</label>
                    <input type="password" id="password" value="123456" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-amber-500 focus:border-amber-500" required>
                </div>
                <button type="submit" class="w-full py-3 bg-teal-700 text-white font-bold rounded-lg hover:bg-teal-800 transition duration-150 shadow-md">登入後台</button>
                <p class="mt-4 text-xs text-stone-500 text-center">
                    **提示:** 此處帳密僅供模擬展示 (teacher / 123456)。
                </p>
            </form>
        </div>
    </div>

    <!-- 管理後台介面 (登入後顯示) -->
    <div id="admin-view" class="min-h-screen bg-stone-50 hidden">
        <header class="bg-white shadow">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-teal-700 handwriting-font">文林附幼 管理中心</h1>
                <button onclick="handleLogout()" class="text-sm font-medium text-stone-600 hover:text-red-500 transition duration-150">登出</button>
            </div>
        </header>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Tab 導覽 -->
            <div class="flex border-b border-gray-200 mb-6 space-x-4">
                <button class="tab-btn py-3 px-4 active" onclick="showAdminTab('announcements')">最新公告管理</button>
                <button class="tab-btn py-3 px-4" onclick="showAdminTab('leave-requests')">請假單審核 (<span id="leave-count">0</span>)</button>
                <button class="tab-btn py-3 px-4" onclick="showAdminTab('medication-requests')">託藥單回覆 (<span id="medication-count">0</span>)</button>
            </div>

            <!-- Tab 內容區 -->
            <div id="admin-content">
                
                <!-- 1. 公告管理 -->
                <div id="announcements" class="tab-content bg-white p-6 rounded-xl card-shadow">
                    <h2 class="text-xl font-bold text-teal-700 mb-4">發布/編輯最新公告</h2>
                    <form onsubmit="saveAnnouncement(event)" class="space-y-4 mb-6">
                        <div>
                            <label for="announcement-title" class="block text-sm font-medium text-stone-700 mb-1">公告標題</label>
                            <input type="text" id="announcement-title" class="w-full p-2 border rounded-lg" placeholder="例如：新學期開學日通知" required>
                        </div>
                        <div>
                            <label for="announcement-tag" class="block text-sm font-medium text-stone-700 mb-1">標籤 (Tag)</label>
                            <select id="announcement-tag" class="w-full p-2 border rounded-lg">
                                <option value="重要">【重要】</option>
                                <option value="活動">【活動】</option>
                                <option value="行政">【行政】</option>
                            </select>
                        </div>
                        <button type="submit" class="py-2 px-4 bg-amber-600 text-white font-bold rounded-lg hover:bg-amber-700 transition duration-150">儲存公告並發布</button>
                    </form>
                    
                    <h3 class="text-lg font-bold text-stone-700 mb-3 border-t pt-4">現有公告列表</h3>
                    <div id="announcement-list" class="space-y-3">
                        <!-- 公告列表將由 JS 渲染 -->
                    </div>
                </div>

                <!-- 2. 請假單審核 -->
                <div id="leave-requests" class="tab-content bg-white p-6 rounded-xl card-shadow hidden">
                    <h2 class="text-xl font-bold text-teal-700 mb-4">待處理請假單</h2>
                    <div id="leave-requests-list" class="space-y-4">
                        <p class="text-stone-500">此處顯示所有家長提交的請假申請。</p>
                        <!-- 請假單列表將由 JS 渲染 -->
                    </div>
                </div>

                <!-- 3. 託藥單回覆 -->
                <div id="medication-requests" class="tab-content bg-white p-6 rounded-xl card-shadow hidden">
                    <h2 class="text-xl font-bold text-teal-700 mb-4">待回覆託藥單</h2>
                    <div id="medication-requests-list" class="space-y-4">
                        <p class="text-stone-500">此處顯示所有家長提交的託藥申請及老師回覆介面。</p>
                        <!-- 託藥單列表將由 JS 渲染 -->
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        const LEAVE_KEY = 'wenlin_leave_requests';
        const MEDICATION_KEY = 'wenlin_medication_requests';
        const ANNOUNCEMENT_KEY = 'wenlin_announcements';

        // --- 登入/登出邏輯 (模擬) ---
        function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            // 模擬驗證
            if (username === 'teacher' && password === '123456') {
                localStorage.setItem('adminLoggedIn', 'true');
                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('admin-view').classList.remove('hidden');
                loadDashboardData();
            } else {
                alert('登入失敗，請檢查帳號和密碼。');
            }
        }

        function handleLogout() {
            localStorage.removeItem('adminLoggedIn');
            document.getElementById('login-view').classList.remove('hidden');
            document.getElementById('admin-view').classList.add('hidden');
        }

        // --- Tab 切換邏輯 ---
        function showAdminTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById(tabName).classList.remove('hidden');
            document.querySelector(`.tab-btn[onclick*="'${tabName}'"]`).classList.add('active');

            // 載入該 Tab 的數據
            if (tabName === 'leave-requests') renderLeaveRequests();
            if (tabName === 'medication-requests') renderMedicationRequests();
            if (tabName === 'announcements') renderAnnouncements();
        }
        
        // --- 公告管理邏輯 ---
        function getAnnouncements() {
            try {
                return JSON.parse(localStorage.getItem(ANNOUNCEMENT_KEY)) || [];
            } catch (e) {
                console.error("Error parsing announcements from localStorage:", e);
                return [];
            }
        }

        function saveAnnouncement(event) {
            event.preventDefault();
            const title = document.getElementById('announcement-title').value;
            const tag = document.getElementById('announcement-tag').value;
            const date = new Date().toLocaleDateString('zh-TW');

            const newAnnouncement = {
                id: Date.now(),
                title: title,
                tag: tag,
                date: date,
                content: "公告內容將在主網頁呈現..."
            };

            const announcements = getAnnouncements();
            announcements.unshift(newAnnouncement); // 新公告放最前面
            localStorage.setItem(ANNOUNCEMENT_KEY, JSON.stringify(announcements));
            
            document.getElementById('announcement-title').value = '';
            alert('公告已成功儲存！');
            renderAnnouncements();
        }

        function deleteAnnouncement(id) {
            let announcements = getAnnouncements();
            announcements = announcements.filter(ann => ann.id !== id);
            localStorage.setItem(ANNOUNCEMENT_KEY, JSON.stringify(announcements));
            alert('公告已刪除。');
            renderAnnouncements();
        }

        function renderAnnouncements() {
            const announcements = getAnnouncements();
            const listContainer = document.getElementById('announcement-list');
            listContainer.innerHTML = '';
            
            if (announcements.length === 0) {
                listContainer.innerHTML = '<p class="text-stone-500">目前沒有公告。</p>';
                return;
            }

            announcements.forEach(ann => {
                const item = document.createElement('div');
                item.className = 'p-3 bg-gray-50 rounded-lg border border-gray-200 flex justify-between items-center';
                item.innerHTML = `
                    <div>
                        <span class="text-xs font-semibold text-teal-700 mr-2">[${ann.tag}]</span>
                        <span class="font-medium text-stone-800">${ann.title}</span>
                        <p class="text-xs text-stone-500 mt-1">發布於: ${ann.date}</p>
                    </div>
                    <button onclick="deleteAnnouncement(${ann.id})" class="ml-4 text-sm text-red-500 hover:text-red-700">刪除</button>
                `;
                listContainer.appendChild(item);
            });
        }
        
        // --- 請假單列表邏輯 ---
        function getLeaveRequests() {
            try {
                return JSON.parse(localStorage.getItem(LEAVE_KEY)) || [];
            } catch (e) {
                console.error("Error parsing leave requests from localStorage:", e);
                return [];
            }
        }

        function renderLeaveRequests() {
            const requests = getLeaveRequests();
            const listContainer = document.getElementById('leave-requests-list');
            listContainer.innerHTML = '';

            if (requests.length === 0) {
                listContainer.innerHTML = '<p class="text-stone-500">目前沒有新的請假申請。</p>';
                document.getElementById('leave-count').textContent = '0';
                return;
            }

            document.getElementById('leave-count').textContent = requests.length;

            requests.forEach((req, index) => {
                const item = document.createElement('div');
                const statusColor = req.status === '待審核' ? 'bg-amber-100 border-amber-400' : 'bg-teal-100 border-teal-400';
                const statusText = req.status === '待審核' ? '待處理' : '已結案';

                item.className = `p-4 rounded-xl border-l-4 ${statusColor} card-shadow`;
                item.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-lg font-bold text-stone-800">${req.childName} (${req.className})</p>
                            <p class="text-sm text-stone-600">家長: ${req.parentName} (${req.relationship})</p>
                            <p class="text-sm text-stone-600">期間: ${req.startDate} ~ ${req.endDate}</p>
                            <p class="text-sm font-medium text-red-700 mt-1">原因: ${req.reason}</p>
                        </div>
                        <div class="text-right">
                            <span class="text-xs font-semibold px-2 py-1 rounded-full ${req.status === '待審核' ? 'bg-red-500 text-white' : 'bg-green-500 text-white'}">${statusText}</span>
                            ${req.status === '待審核' ? `<button onclick="updateLeaveStatus(${req.id}, '已審核')" class="mt-2 text-sm text-teal-700 hover:underline">標記為已審核</button>` : ''}
                        </div>
                    </div>
                `;
                listContainer.appendChild(item);
            });
        }

        function updateLeaveStatus(id, newStatus) {
            let requests = getLeaveRequests();
            const index = requests.findIndex(req => req.id === id);
            if (index !== -1) {
                requests[index].status = newStatus;
                localStorage.setItem(LEAVE_KEY, JSON.stringify(requests));
                renderLeaveRequests();
                alert(`請假單 (ID: ${id}) 已標記為 ${newStatus}`);
            }
        }
        
        // --- 託藥單列表與回覆邏輯 ---
        function getMedicationRequests() {
             try {
                return JSON.parse(localStorage.getItem(MEDICATION_KEY)) || [];
            } catch (e) {
                console.error("Error parsing medication requests from localStorage:", e);
                return [];
            }
        }

        function renderMedicationRequests() {
            const requests = getMedicationRequests();
            const listContainer = document.getElementById('medication-requests-list');
            listContainer.innerHTML = '';
            
            if (requests.length === 0) {
                listContainer.innerHTML = '<p class="text-stone-500">目前沒有新的託藥申請。</p>';
                document.getElementById('medication-count').textContent = '0';
                return;
            }

            document.getElementById('medication-count').textContent = requests.length;

            requests.forEach((req, index) => {
                const isReplied = req.teacherReply && req.teacherReply.time;
                const statusColor = isReplied ? 'bg-green-100 border-green-400' : 'bg-amber-100 border-amber-400';
                
                const item = document.createElement('div');
                item.className = `p-4 rounded-xl border-l-4 ${statusColor} card-shadow`;
                item.innerHTML = `
                    <div class="text-lg font-bold text-stone-800">${req.childName} (${req.className}) - ${req.drugName}</div>
                    <p class="text-sm text-stone-600">日期: ${req.date} | 服藥時間: ${req.time}</p>
                    <p class="text-sm text-stone-600">病名/病徵: ${req.symptoms} | 需冷藏: ${req.refrigeration ? '是 (請注意)' : '否'}</p>
                    <p class="text-sm text-stone-600 mb-3">家長 Email: <span class="text-teal-700">${req.parentEmail}</span></p>

                    ${isReplied ? `
                        <div class="mt-3 p-3 bg-green-50 rounded-lg border border-green-300">
                            <p class="font-bold text-green-700">✅ 已回覆記錄 (${req.teacherReply.teacher})</p>
                            <p class="text-sm text-green-600">時間: ${req.teacherReply.time}</p>
                            <p class="text-sm text-green-600">情況: ${req.teacherReply.note}</p>
                        </div>
                    ` : `
                        <form onsubmit="handleTeacherReply(event, ${req.id})" class="mt-3 space-y-2 p-3 bg-white rounded-lg border border-gray-300">
                            <h5 class="font-semibold text-teal-700">老師回覆區</h5>
                            <input type="text" name="teacher_time" placeholder="餵藥時間 (e.g., 12:35 PM)" class="w-full p-2 border rounded-lg text-sm" required>
                            <textarea name="teacher_note" placeholder="餵藥情況回覆" rows="2" class="w-full p-2 border rounded-lg text-sm" required></textarea>
                            <input type="text" name="teacher_name" placeholder="操作教師姓名" class="w-full p-2 border rounded-lg text-sm" required>
                            <button type="submit" class="w-full py-2 bg-teal-600 text-white text-sm font-bold rounded-lg hover:bg-teal-700 transition">送出餵藥回覆 (模擬發送 Email)</button>
                        </form>
                    `}
                `;
                listContainer.appendChild(item);
            });
        }

        function handleTeacherReply(event, id) {
            event.preventDefault();
            
            const form = event.target;
            const reply = {
                id: id,
                time: form.elements.teacher_time.value,
                note: form.elements.teacher_note.value,
                teacher: form.elements.teacher_name.value,
                timestamp: new Date().toISOString()
            };

            let requests = getMedicationRequests();
            const index = requests.findIndex(req => req.id === id);

            if (index !== -1) {
                requests[index].teacherReply = reply;
                localStorage.setItem(MEDICATION_KEY, JSON.stringify(requests));
                
                // 模擬 Email 寄送提示
                alert(`回覆已記錄，並模擬發送 Email 給家長: ${requests[index].parentEmail}`);
                
                renderMedicationRequests();
            }
        }
        
        // --- 儀表板通用加載 ---
        function loadDashboardData() {
            // 初始化數據
            const leaveRequests = getLeaveRequests();
            const medicationRequests = getMedicationRequests();
            const announcements = getAnnouncements();

            // 更新計數
            document.getElementById('leave-count').textContent = leaveRequests.filter(r => r.status === '待審核').length;
            document.getElementById('medication-count').textContent = medicationRequests.filter(r => !r.teacherReply || !r.teacherReply.time).length;
            
            // 預設渲染公告
            renderAnnouncements();
        }

        // 檢查是否已登入
        if (localStorage.getItem('adminLoggedIn') === 'true') {
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('admin-view').classList.remove('hidden');
            loadDashboardData();
        }
    </script>
</body>
</html>
